import{aW as J,aX as B,aY as N,aZ as Q,a_ as D,r as d,j as r,B as M,e as G,f as T,Z as m,a3 as b}from"./index-TOg4iC9X.js";import{u as Z}from"./index.esm-B-kGqaSt.js";import U from"./PaymentHistory-DNVtseFP.js";import{M as h}from"./MenuItem-DFBgWJ5J.js";import"./TableRow-Csk7A2q-.js";import"./TablePagination-5p5xmu9T.js";import"./Toolbar-DEMU4rmm.js";import"./listItemTextClasses-BwEbF0GS.js";import"./dividerClasses-9ENEhr9G.js";const k=["January","February","March","April","May","June","July","August","September","October","November","December"],le=()=>{var Y,S,$,z,_;const{data:t,isLoading:q}=J(),{register:l,handleSubmit:W,setValue:n,watch:p,formState:{errors:i}}=Z({defaultValues:{frequency:"Monthly",month:"",year:new Date().getFullYear(),amount:0,paymentMethod:"online"}}),[E,{isLoading:j,isError:I,error:x}]=B(),{data:g,isLoading:X,error:K}=N(),[R]=Q(),[A]=D(),[w,c]=d.useState(null),u=p("frequency");p("month"),p("year");const f=new Date().getFullYear(),L=e=>k.map(o=>({month:o,year:e,key:`${o}-${e}-${u}`})),v=new Set((g==null?void 0:g.payments.map(e=>`${e.month}-${e.year}-${e.frequency}`))||[]),V=d.useMemo(()=>L(f),[u,f]);d.useEffect(()=>{if(!window.Razorpay){const e=document.createElement("script");e.src="https://checkout.razorpay.com/v1/checkout.js",e.async=!0,document.body.appendChild(e)}},[]),d.useEffect(()=>{if(t!=null&&t.setting){const{amount:e,month:o,year:a,frequency:s}=t.setting;n("frequency",s||"Monthly"),n("year",a),s==="Yearly"?n("month","January"):n("month",o)}},[t,n]),d.useEffect(()=>{if(!(t!=null&&t.setting))return;const e=t.setting,o=new Date,a=k[o.getMonth()],s=o.getFullYear();u==="Monthly"?(n("month",a),n("year",s),n("amount",e.monthlyRate)):u==="Yearly"&&(n("month","January"),n("year",s),n("amount",e.yearlyRate))},[u,t,n]);const O=u==="Yearly",C=async e=>{const o=`${e.month}-${e.year}-${e.frequency}`;if(v.has(o))return c("failure"),alert(`You have already paid for ${e.month} ${e.year} (${e.frequency})`);c(null);try{if(e.paymentMethod==="online"){const a=await R({amount:e.amount,month:e.month,year:e.year,frequency:e.frequency}).unwrap(),s={key:"rzp_test_Q2R8yPk3O6GHhU",amount:a.amount,currency:a.currency,name:"Society Maintenance",description:`Maintenance for ${e.month} ${e.year} (${e.frequency})`,order_id:a.id,handler:async function(y){try{await A({...e,razorpay_order_id:y.razorpay_order_id,razorpay_signature:y.razorpay_signature,transactionId:y.razorpay_payment_id}).unwrap(),c("success")}catch(H){console.error("Verification failed",H),c("failure")}},theme:{color:"#1976d2"}};new window.Razorpay(s).open()}else await E(e).unwrap(),c("success")}catch(a){console.error("Payment failed:",a),c("failure")}},P=[];for(let e=f-5;e<=f+5;e++)P.push(e);return r.jsxs(r.Fragment,{children:[r.jsxs(M,{component:"form",margin:2,onSubmit:W(C),sx:{mx:"auto",mt:4,p:3,borderRadius:2,backgroundColor:"background.paper",boxShadow:1,display:"flex",flexDirection:"column",gap:2},children:[r.jsx(G,{variant:"h6",gutterBottom:!0,children:"Pay Maintenance"}),r.jsx(M,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:V.map(({month:e,year:o,key:a})=>{const s=v.has(a),F=u==="Yearly";return r.jsx(T,{variant:"outlined",size:"small",disabled:s||F,sx:{textTransform:"none",borderColor:s?"success.main":"error.main",color:s?"success.main":"error.main"},onClick:()=>{var y;n("month",e),n("year",o),n("frequency","Monthly"),n("amount",((y=t==null?void 0:t.setting)==null?void 0:y.monthlyRate)||0)},children:e},a)})}),r.jsxs(M,{sx:{display:"flex",flexWrap:"wrap",gap:20,mt:2},children:[r.jsxs(m,{select:!0,variant:"standard",label:"Frequency",...l("frequency",{required:"Frequency is required"}),error:!!i.frequency,helperText:(Y=i.frequency)==null?void 0:Y.message,defaultValue:"Monthly",sx:{minWidth:150},children:[r.jsx(h,{value:"Monthly",children:"Monthly"}),r.jsx(h,{value:"Yearly",children:"Yearly"})]}),r.jsx(m,{label:"Month",variant:"standard",...l("month",{required:"Month is required"}),error:!!i.month,helperText:(S=i.month)==null?void 0:S.message,disabled:O,InputLabelProps:{shrink:!0},sx:{minWidth:150}}),r.jsx(m,{select:!0,variant:"standard",label:"Year",...l("year",{required:"Year is required",valueAsNumber:!0}),error:!!i.year,helperText:($=i.year)==null?void 0:$.message,sx:{minWidth:120},children:P.map(e=>r.jsx(h,{value:e,children:e},e))}),r.jsx(m,{label:"Amount (â‚¹)",variant:"standard",type:"number",InputProps:{readOnly:!0},...l("amount",{required:"Amount is required"}),error:!!i.amount,helperText:(z=i.amount)==null?void 0:z.message,sx:{minWidth:150}}),r.jsxs(m,{select:!0,variant:"standard",label:"Payment Method",...l("paymentMethod",{required:!0}),defaultValue:"online",sx:{minWidth:180},children:[r.jsx(h,{value:"online",children:"Online"}),r.jsx(h,{value:"offline",children:"Offline / Cash"})]})]}),p("paymentMethod")==="offline"&&r.jsx(m,{label:"Transaction ID (if any)",fullWidth:!0,margin:"normal",...l("transactionId"),helperText:"Fill if paid offline"}),r.jsx(T,{type:"submit",variant:"contained",color:"secondary",disabled:j||q,children:j?"Processing...":q?"Loading Setting...":"Pay Now"}),w==="success"&&r.jsx(b,{severity:"success",children:"Payment successful!"}),w==="failure"&&r.jsx(b,{severity:"error",children:"Payment failed. Please try again."}),I&&r.jsx(b,{severity:"error",children:((_=x==null?void 0:x.data)==null?void 0:_.message)||"Something went wrong"})]}),r.jsx(U,{})]})};export{le as default};
